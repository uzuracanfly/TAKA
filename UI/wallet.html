<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
</head>

<style type="text/css">
<!--
#outer
{
	width:100%;
	padding: 0;
	margin: 0;
}
#inner
{
	width:100%;
	padding: 0;
	margin: 0 auto;
	position: absolute;
	top: 300px;
}
.sub
{
	width:100%;
	margin:0 auto;
}
-->


h1 {
	color: #6594e0;/*文字色*/
	/*線の種類（点線）2px 線色*/
	border-bottom: dashed 2px #6594e0;
}
h2 {
	color: #364e96;/*文字色*/
	border: solid 3px #364e96;/*線色*/
	border-radius: 0.5em;/*角丸*/
}
</style>









<div id="outer">
	<div id="inner">
	</div>
</div>









<script src="//code.jquery.com/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/clipboard.js/1.5.3/clipboard.min.js"></script>

<script src="lib/basicfunctions"></script>
<script src="lib/TAKAAPIRapper"></script>
<script src="lib/form"></script>
<script src="lib/notification"></script>
<script src="lib/TAKALIBRapper"></script>

<script>
	const TAKA = new TAKAAPIRapper("133.18.169.253",80);
	let Notification = new notification();
	let account = {};







	function SendTransaction(type,tag,toaddress,amount,data,privkey=account["privkey"]){
		return new Promise(function (resolve, reject) {

			let address = new ACCOUNT.account(privkey).GetKeys()["address"];

			let AccountData = TAKA.getaccount(address);
			let MerkleRoot = "";
			let txs = [];
			if (tag in AccountData["txids"]){
				MerkleRoot = AccountData["txids"][tag]["MerkleRoot"];
				txs = AccountData["txids"][tag]["txs"];
			}
			let index = txs.length;

			let objtx = {
				"pubkey":account["pubkey"],
				"type":type,
				"time":Math.floor(Date.now()/1000),
				"tag":tag,
				"index":index+1,
				"MerkleRoot":MerkleRoot,
				"toaddress":toaddress,
				"amount":amount,
				"data":data,
				"sig":"",
				"nonce":0,
			};

			let TargetTransaction = new TRANSACTION.Transaction("",privkey,objtx);



			let target = BigInt("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");
			if (tag == "pay" || tag == "tagreward"){
				target = BigInt("0x00ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");
			}
			if (tag != "pay" && tag != "tagreward" && index > 0){
				let objfirsttx = TAKA.gettx(txs[0]);

				let FIRSTTXDATA = new TRANSACTIONTOOLS_TAGORDER.TagOrderData(objfirsttx["data"]);
				let objdata = FIRSTTXDATA.GetObjData();

				target = BigInt("0x"+objdata["powtarget"]);
			}

			let result = TargetTransaction.GetNonce(TargetTransaction.GetRawTx(),target);
			let objsendtx = TargetTransaction.GetObjTx();



			result.then(function(nonce){

				objsendtx["nonce"] = nonce;

				TargetTransaction = new TRANSACTION.Transaction("",privkey,objsendtx);
				let rawtx = TargetTransaction.GetRawTx();


				TAKA.sendtx(
					rawtx,
					function(CallbackResult,CallbackArgs){
						return resolve({"txid":CallbackResult,"rawtx":rawtx});
					}
				);
			});
		});
	};
















	function Login(){
		let formargs = [
			["title","Login"],
			["input","privkey","privkey"],
			[
				"button",
				"Login",
				function()
				{
					let privkey = document.getElementById("privkey").value;

					let keys = new ACCOUNT.account(privkey).GetKeys();

					account = keys;

					TopForm();
				}
			],
			[
				"button",
				"NewAccount",
				function()
				{
					let keys = new ACCOUNT.account().GetKeys();

					let LoginNewAccountForm = new form(
						[
							["title","New Account"],
							["head","Privkey"],
							["text","SAVE THIS! AND NOT BE SHOWN TO PEOPLE!"],
							["input","privkey","mprivkey"],
							["head","Pubkey"],
							["input","pubkey","pubkey"],
							["head","Address"],
							["text","THIS IS USING RECEIVE COINS! YOU CAN SHOW THIS!"],
							["input","address","address"],
						],
						"LoginNewAccountForm"
					);
					document.getElementById("privkey").value = keys["privkey"];
					document.getElementById("mprivkey").value = keys["privkey"];
					document.getElementById("pubkey").value = keys["pubkey"];
					document.getElementById("address").value = keys["address"];
				}
			],
		];

		let LoginForm = new form(
			formargs,
			"LoginForm"
		);

		return true;
	}


	function TopForm(){
		TAKA.getaccount(
			account["address"],
			0,
			function(CallbackResult,CallbackArgs){
				let formargs = [
					["head","Address"],
					["text",account["address"]],
					["head","Balance"],
					["text",CallbackResult["balance"]],
					[
						"button",
						"Withdraw",
						function()
						{
							let formargs = [
								["title","Withdraw"],
								["input","toaddress","toaddress"],
								["input","amount","amount"],
								[
									"button",
									"send",
									function()
									{
										let toaddress = document.getElementById("toaddress").value;
										let amount = document.getElementById("amount").value;
										amount = parseInt(amount);


										let result = SendTransaction(1,"pay",toaddress,amount,"");


										//送信ロード画面
										let TopLoadForm = new form(
											[
												["title","Sending....."]
											],
											"TopLoadForm"
										);


										result.then(function(TxResult){
											TopLoadForm.DeleteForm();

											let TopResultForm = new form(
												[
													["title","Result"],
													["head","Result"],
													["input","result","result"],
													["head","RawTx"],
													["input","rawtx","rawtx"],
													[
														"button",
														"Done",
														function()
														{
															TopResultForm.DeleteForm();
															TopWithdrawForm.DeleteForm();
														}
													]
												],
												"TopResultForm"
											);

											document.getElementById("result").value = TxResult["txid"];
											document.getElementById("rawtx").value = TxResult["rawtx"];
										});
									}
								]
							]


							let TopWithdrawForm = new form(
								formargs,
								"TopWithdrawForm"
							);
						}
					],
					[
						"button",
						"TagOrder",
						function()
						{
							let TopTagOrderForm = new form(
								[
									["title","Tag Order"],
									["input","tag","tag"],
									["input","Permission Type","permissiontype"],
									["input","Pow Target","powtarget"],
									[
										"button",
										"send",
										function()
										{
											let tag = document.getElementById("tag").value;
											let permissiontype = document.getElementById("permissiontype").value;
											let powtarget = document.getElementById("powtarget").value;

											if (!powtarget){
												powtarget = "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";
											};


											//FeeTx作成
											let result = SendTransaction(1,"pay","0000000000000000000000000000000000000000",1,"");


											//送信ロード画面
											let TopLoadForm = new form(
												[
													["title","Sending....."]
												],
												"TopLoadForm"
											);


											result.then(function(FeeTxResult){
												TopLoadForm.DeleteForm();
												if (!FeeTxResult){
													let TopFailForm = new form(
														[
															["title","FAIL"]
														],
														"TopFailForm"
													);
												}



												//TagOrderのデータ生成
												let objdata = {
													"feetxid":FeeTxResult["txid"],
													"permissiontype":permissiontype,
													"powtarget":powtarget,
												};

												let TXDATA = new TRANSACTIONTOOLS_TAGORDER.TagOrderData("",objdata);
												let rawdata = TXDATA.GetRawData();



												//TagOrderTx作成
												let TagOrderResult = SendTransaction(12,tag,"0000000000000000000000000000000000000000",0,rawdata);

												TopLoadForm = new form(
													[
														["title","Sending....."]
													],
													"TopLoadForm"
												);

												TagOrderResult.then(function(TagOrderTxResult){
													TopLoadForm.DeleteForm();

													let TopResultForm = new form(
														[
															["title","Result"],
															["head","Result"],
															["input","result","result"],
															["head","RawTx"],
															["input","rawtx","rawtx"],
															[
																"button",
																"Done",
																function()
																{
																	TopResultForm.DeleteForm();
																	TopTagOrderForm.DeleteForm();
																}
															]
														],
														"TopResultForm"
													);

													document.getElementById("result").value = TagOrderTxResult["txid"];
													document.getElementById("rawtx").value = TagOrderTxResult["rawtx"];
												}).catch(function(e){
													console.log(e);
												});
											}).catch(function(e){
												console.log(e);
											});
										}
									]
								],
								"TopTagOrderForm"
							);
						}
					],
					[
						"button",
						"Tagreward",
						function()
						{
							let TopTagrewardForm = new form(
								[
									["title","Tagreward"],
									["text","You can pay reward for node administrator keeping the specified tag."],
									["input","tag","tag"],
									["input","amount","amount"],
									[
										"button",
										"send",
										function()
										{
											let tag = document.getElementById("tag").value;
											let amount = document.getElementById("amount").value;

											let TagData = TAKA.gettag(tag);
											let TagsMerkleRoot = TagData["MerkleRoot"];
											if (!TagsMerkleRoot){
												let TopFailForm = new form(
													[
														["title","FAIL"]
													],
													"TopFailForm"
												);
											}

											let RewardPrivkeyKeys = new ACCOUNT.account().GetKeys();
											let EncryptoPrivkey = new CRYPTO.common().GetEncryptedData(TagsMerkleRoot,RewardPrivkeyKeys["privkey"]);

											let result = SendTransaction(1,"pay",RewardPrivkeyKeys["address"],amount,"");



											//送信ロード画面
											let TopLoadForm = new form(
												[
													["title","Sending....."]
												],
												"TopLoadForm"
											);


											result.then(function(FeeTxResult){
												TopLoadForm.DeleteForm();
												if (!FeeTxResult){
													let TopFailForm = new form(
														[
															["title","FAIL"]
														],
														"TopFailForm"
													);
												}



												//tagrewardのデータ生成
												let objdata = {
													"tag":tag,
													"EncryptoPrivkey":EncryptoPrivkey,
												};

												let TXDATA = new TRANSACTIONTOOLS_TAGREWARD.TagrewardData("",objdata);
												let rawdata = TXDATA.GetRawData();



												//TagrewardTx作成
												let TagrewardResult = SendTransaction(11,"tagreward","0000000000000000000000000000000000000000",0,rawdata);



												TopLoadForm = new form(
													[
														["title","Sending....."]
													],
													"TopLoadForm"
												);

												///Tagrewardの結果発表
												TagrewardResult.then(function(TagrewardTxResult){
													TopLoadForm.DeleteForm();

													let TopResultForm = new form(
														[
															["title","Result"],
															["head","Result"],
															["input","result","result"],
															["head","RawTx"],
															["input","rawtx","rawtx"],
															[
																"button",
																"Done",
																function()
																{
																	TopResultForm.DeleteForm();
																	TopTagOrderForm.DeleteForm();
																}
															]
														],
														"TopResultForm"
													);

													document.getElementById("result").value = TagrewardTxResult["txid"];
													document.getElementById("rawtx").value = TagrewardTxResult["rawtx"];
												}).catch(function(e){
													console.log(e);
												});

											}).catch(function(e){
												console.log(e);
											});
										}
									]
								]
							);
						}
					],
					[
						"button",
						"Tag add permit",
						function()
						{
							let TopTagAddpermForm = new form(
								[
									["title","Tag add permit"],
									["input","tag","tag"],
									["input","Add address","addaddress"],
									[
										"button",
										"send",
										function()
										{
											let tag = document.getElementById("tag").value;
											let addaddress = document.getElementById("addaddress").value;

											//tagrewardのデータ生成
											let objdata = {
												"address":addaddress,
											};

											let TXDATA = new TRANSACTIONTOOLS_TAGADDPERMIT.TagAddPermitData("",objdata);
											let rawdata = TXDATA.GetRawData();

											let result = SendTransaction(13,tag,"0000000000000000000000000000000000000000",0,rawdata);


											//送信ロード画面
											let TopLoadForm = new form(
												[
													["title","Sending....."]
												],
												"TopLoadForm"
											);

											result.then(function(TxResult){
												TopLoadForm.DeleteForm();

												let TopResultForm = new form(
													[
														["title","Result"],
														["head","Result"],
														["input","result","result"],
														["head","RawTx"],
														["input","rawtx","rawtx"],
														[
															"button",
															"Done",
															function()
															{
																TopResultForm.DeleteForm();
																TopTagOrderForm.DeleteForm();
															}
														]
													],
													"TopResultForm"
												);

												document.getElementById("result").value = TxResult["txid"];
												document.getElementById("rawtx").value = TxResult["rawtx"];

											}).catch(function(e){
												console.log(e);
											});


										}
									]
								]
							);
						}
					],
					[
						"button",
						"Database",
						function()
						{
							let TopTagrewardForm = new form(
								[
									["title","Database"],
									["input","tag","tag"],
									["input","data","data"],
									["input","commonkey","commonkey"],
									[
										"button",
										"send",
										function()
										{


											let tag = document.getElementById("tag").value;
											let data = document.getElementById("data").value;
											let commonkey = document.getElementById("commonkey").value;


											if (commonkey){
												data = new CRYPTO.common().GetEncryptedData(commonkey,data);
											}


											let result = SendTransaction(101,tag,"0000000000000000000000000000000000000000",0,data);


											//送信ロード画面
											let TopLoadForm = new form(
												[
													["title","Sending....."]
												],
												"TopLoadForm"
											);

											result.then(function(TxResult){
												TopLoadForm.DeleteForm();

												let TopResultForm = new form(
													[
														["title","Result"],
														["head","Result"],
														["input","result","result"],
														["head","RawTx"],
														["input","rawtx","rawtx"],
														[
															"button",
															"Done",
															function()
															{
																TopResultForm.DeleteForm();
																TopTagOrderForm.DeleteForm();
															}
														]
													],
													"TopResultForm"
												);

												document.getElementById("result").value = TxResult["txid"];
												document.getElementById("rawtx").value = TxResult["rawtx"];
												
											}).catch(function(e){
												console.log(e);
											});


										}
									]
								]
							);
						}
					]


				];

				let TopForm = new form(
					formargs,
					"TopForm"
				);
			},
			{}
		);

		return true;
	}
</script>





<script>
	window.onload = function(){
		let outer=document.getElementById("outer");
		let inner=document.getElementById("inner");


		Login();
	};
</script>